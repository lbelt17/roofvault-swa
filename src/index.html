<!DOCTYPE html>
<html>
  <head><meta charset="utf-8"><title>RoofVault SWA</title></head>
  <body style="font-family: system-ui; padding: 24px;">
    <h1>RoofVault SWA — AI Training Tool</h1>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="btnPing">Ping API</button>
      <button id="btnGen5">Generate 5 (QC test)</button>
      <button id="btnGen50">Generate 50 (Client-batched)</button>
      <button id="btnSummAll">Summarize All Publications</button>
      <button id="btnGroup">Group Questions by Objectives</button>
    </div>

    <pre id="out" style="white-space:pre-wrap; border:1px solid #ccc; padding:12px;"></pre>

    <script>
      const out = document.getElementById('out');
      const show = o => out.textContent = typeof o === 'string' ? o : JSON.stringify(o,null,2);
      const sleep = ms => new Promise(r=>setTimeout(r,ms));

      async function call(path,body){
        const opt = body?{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}:{};
        const r = await fetch(path,opt); const t = await r.text();
        try { return {ok:r.ok,status:r.status,data:JSON.parse(t)}; } catch { return {ok:r.ok,status:r.status,data:t}; }
      }

      window.lastItems = [];  window.lastSummaries = [];

      document.getElementById('btnPing').onclick = async ()=>show(await call('/api/ping'));
      document.getElementById('btnGen5').onclick  = async ()=>{
        const r=await call('/api/generate-questions',{count:5,onlyIIBEC:true});
        if(r.ok&&r.data?.items) window.lastItems=r.data.items; show(r);
      };
      document.getElementById('btnGen50').onclick = async ()=>{
        const all=[]; for(let i=0;i<10;i++){
          show({progress:`Batch ${i+1}/10 …`});
          const r=await call('/api/generate-questions',{count:5,onlyIIBEC:true});
          if(!r.ok) return show(r);
          all.push(...(r.data?.items||[])); await sleep(800);
        }
        window.lastItems=all; show({ok:true,total:all.length,items:all});
      };

      // 🔹 Summarize all publications (loop 10x to cover blobs)
      document.getElementById('btnSummAll').onclick = async ()=>{
        const names=["IIBEC","NRCA","ASTM","Manual of Practice","Contract Administration","Thermoplastic Roofing"];
        const all=[];
        for(let i=0;i<names.length;i++){
          show({progress:`Summarizing ${names[i]} (${i+1}/${names.length})…`});
          const r=await call('/api/summarize-publication',{publication:names[i],onlyIIBEC:true});
          if(r.ok&&r.data) all.push({name:names[i],...r.data});
          await sleep(1200);
        }
        window.lastSummaries=all;
        show({ok:true,count:all.length,summaries:all});
      };

      document.getElementById('btnGroup').onclick = async ()=>{
        if(!window.lastItems?.length) return show({error:"Generate questions first"});
        const r=await call('/api/group-questions',{items:window.lastItems});
        show(r);
      };
    </script>
  </body>
</html>
