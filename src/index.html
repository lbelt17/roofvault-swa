<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RoofVault AI — Training Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Light theme */
      --bg:#f5f7fb; --card:#ffffff; --ink:#0b0d12; --muted:#5b6b82; --accent:#1d6cff; --ring:#d7e2ff;
      --ok:#1f9d55; --warn:#b7791f; --err:#e5534b; --chip:#eef2f7; --border:#dfe6f2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:24px;letter-spacing:.2px}
    .sub{color:var(--muted);margin-bottom:18px}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .toolbar input[type="text"]{width:360px;max-width:100%;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--ink)}

    .btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    button{background:#fff;border:1px solid var(--border);color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
    button:hover{border-color:#cfd8e6}
    .copy{background:#f7faff}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:16px}
    .col-8{grid-column:span 8}
    .col-4{grid-column:span 4}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px;font-size:16px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}

    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
    .hidden{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>RoofVault AI — Training Tool</h1>
    <div class="sub">Generate interactive practice exams from your uploaded manuals.</div>

    <div class="toolbar">
      <label>Keywords
        <input id="kw" type="text" placeholder="e.g., membrane roofs; waterproofing; fire ratings">
      </label>

      <!-- Single mount point for the Book dropdown -->
      <div id="bookMount"></div>

      <span class="chip">Model: <span id="model">auto</span></span>
      <span id="status" class="muted">Ready</span>

      <div class="btnbar">
        <button id="btnPing" onclick="return pingInline();">Ping</button>
        <button id="btnGen5">Generate 5</button>
        <button id="btnGenExam50ByBook" onclick="return examInline();">Generate Exam (50 by Book)</button>
      </div>
    </div>

    <div class="grid">
      <div class="col-8">
        <div class="card">
          <h3>Questions</h3>
          <div id="qList" class="muted">No questions yet.</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Summary</h3>
          <div id="summaryBlock" class="muted">No summary yet.</div>
        </div>
      </div>

      <div class="col-4">
        <div class="card">
          <h3>Sources & Controls</h3>
          <div id="sources" class="muted">None</div>
          <div class="row" style="margin-top:10px">
            <button id="btnCopyQs" class="copy">Copy Questions</button>
            <button id="btnCopySum" class="copy">Copy Summary</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Diagnostics</h3>
          <div id="diag" class="mono muted">Idle</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Grouped Book Dropdown Loader (THIS is the fix) ===== -->
  <script>
    (function(){
      async function loadBooks(){
        const mount = document.getElementById("bookMount");
        if (!mount) return;
        mount.innerHTML = "";

        const res = await fetch("/api/books");
        const data = await res.json(); // { field, values, books }
        const field = data.field || null;

        // Prefer grouped books; fallback to legacy values
        const items = (Array.isArray(data.books) && data.books.length)
          ? data.books.map(b => ({
              value: b.bookGroupId,
              label: b.displayTitle,
              parts: Array.isArray(b.parts) ? b.parts : []
            }))
          : (Array.isArray(data.values) ? data.values : []).map(v => ({
              value: v,
              label: v,
              parts: [v]
            }));

        const label = document.createElement("label");
        label.textContent = "Book";
        label.style.display = "flex";
        label.style.flexDirection = "column";
        label.style.gap = "6px";

        const sel = document.createElement("select");
        sel.id = "bookSelect";
        sel.style.minWidth = "260px";

        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "(All Books)";
        optAll.dataset.parts = "[]";
        sel.appendChild(optAll);

        items.forEach(item=>{
          const o = document.createElement("option");
          o.value = item.value;                 // group id (or raw filename fallback)
          o.textContent = item.label;           // clean title shown
          o.dataset.parts = JSON.stringify(item.parts || []);
          sel.appendChild(o);
        });

        const meta = document.createElement("div");
        meta.className = "muted";
        meta.style.fontSize = "12px";
        meta.textContent = field ? `field: ${field}` : "field: ?";

        label.appendChild(sel);
        label.appendChild(meta);
        mount.appendChild(label);

        // Expose selection for other scripts
        window.getSelectedBook = () => {
          const opt = sel.options[sel.selectedIndex];
          let parts = [];
          try { parts = JSON.parse(opt?.dataset?.parts || "[]"); } catch (e) {}
          return {
            value: sel.value,                        // bookGroupId
            label: opt?.textContent || sel.value,    // display title
            field,
            parts                                   // list of real part filenames
          };
        };
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadBooks);
      } else {
        loadBooks();
      }
    })();
  </script>

  <!-- ===== Minimal page logic (keeps your buttons working) ===== -->
  <script>
    const statusEl = document.getElementById('status');
    const modelEl  = document.getElementById('model');
    const qList    = document.getElementById('qList');
    const summaryBlock = document.getElementById('summaryBlock');
    const diagEl   = document.getElementById('diag');
    const kwEl     = document.getElementById('kw');

    const setStatus = (t) => statusEl.textContent = t || 'Ready';
    const showDiag = (o) => {
      try { diagEl.textContent = typeof o==='string' ? o : JSON.stringify(o,null,2); }
      catch { diagEl.textContent = String(o); }
    };

    const basePayload = () => ({ keywords:(kwEl.value||'').trim() });

    async function call(path, body){
      const opt = body ? { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)} : {};
      const res = await fetch(path,opt);
      const txt = await res.text();
      try { return { ok:res.ok, status:res.status, data:JSON.parse(txt) }; }
      catch { return { ok:res.ok, status:res.status, data:txt }; }
    }

    async function doGen(n){
      setStatus(`Generating ${n}…`);
      const r = await call('/api/generate-questions', { ...basePayload(), count:n });
      setStatus(`HTTP ${r.status}`);
      showDiag(r);
      if (r.ok && r.data?.items){
        // If you have a renderer elsewhere, it can hook in; otherwise show raw
        if (window.renderQuestions) window.renderQuestions(r.data.items);
        else qList.textContent = JSON.stringify(r.data.items, null, 2);
        if (r.data.modelDeployment) modelEl.textContent = r.data.modelDeployment;
      }
    }

    document.getElementById('btnGen5').onclick = () => doGen(5);

    // Used by inline onclick attributes
    window.pingInline = async function(){
      try{
        showDiag("Calling /api/ping …");
        const r = await call('/api/ping');
        setStatus(`HTTP ${r.status}`);
        showDiag(r);
      }catch(e){
        showDiag({ ok:false, error:String(e && e.message || e) });
      }
      return false;
    };

    // This sends the SELECTED GROUP ID for now.
    // Next step (after you say done): we will change /api/exam to use parts[].
    window.examInline = async function(){
      try{
        const pick = (window.getSelectedBook && window.getSelectedBook()) || {};
        const book = pick.value || ""; // currently bookGroupId
        setStatus("Generating exam…");
        showDiag({ note:"Calling /api/exam", pick });

        const r = await call('/api/exam', { book, keywords:(kwEl.value||"").trim() });
        setStatus(`HTTP ${r.status}`);
        showDiag(r);

        // If your exam renderer expects ExamText, keep it compatible
        if (r.ok && r.data?.items && Array.isArray(r.data.items)) {
          window.ExamText = "## Exam Output\n" + r.data.items.join("\n\n");
          if (window.renderInteractiveExam) window.renderInteractiveExam();
        }
      }catch(e){
        showDiag({ ok:false, error:String(e && e.message || e) });
      }
      return false;
    };

    // visual confirmation
    try { if (diagEl) diagEl.textContent = "JS loaded"; } catch(e){}
  </script>

  <!-- Keep your interactive exam widget mounts/scripts if you use them -->
  <div id="interactive-exam"></div>
  <script src="/frontend/render-bridge.js"></script>
  <script src="/frontend/interactive-exam.js"></script>
  <script src="/frontend/exam-sample.js"></script>
  <script src="/frontend/app.js"></script>
  <script src="/frontend/ping.js"></script>

</body>
</html>
